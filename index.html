    <!DOCTYPE html>
    <html>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

        <style>
            #tooltip {
                opacity: 0;
                position: absolute;
                text-align: center;
                width: 215px; height: 75px;
                background: white;
                border: 1px solid;
            }
        </style>

        <body onload="init()">
            <h1>The Sad Truth: The Poorer You Are, The Faster You Die. </h1>
            <P> Here is a graph plotting life expectancy against GDP per capita, using a dataset from 2018. Do you notice any trend?</P>

            <div><input type="checkbox" class="checkbox" value="Trend" unchecked><label>Trend</label></div>
            <div id ="scatterplot"></div>
            <div id="tooltip"></div>
            <script>
                var width = 700;
                var height = 700;
                var margin = 50;

                var svg = d3.select("#scatterplot")
                    .append("svg")
                        .attr("width", width + 2*margin)
                        .attr("height", height + 2*margin);


                async function init() {
                    const data = await d3.csv(
                        'https://raw.githubusercontent.com/ssong44/ssong44.github.io/main/Data/data_filtered.csv');
                    var x = d3.scaleLog().domain([500, 160000]).range([0, width]).base(10);
                    var y = d3.scaleLinear().domain([50, 85]).range([height, 0]);
                    var pop = d3.scaleLog().domain([20000000, 2000000000]).range([5, 30]).base(10);
                    var continents = ["Africa", "Asia", "Europe", "North America", "Middle & South America", "Oceania"]
                    var color = d3.scaleOrdinal().domain(continents).range(d3.schemeSet2);
                    var tooltip = d3.select("#tooltip");
                    var currentFilter = "none";

                    var dataReady = continents.map(function(continent) {
                        return {
                            name: continent,
                            values: data.map(function(d) {
                                return {country: d.country, value: +d[continent]};
                            })
                        };
                    });

                    // Axes
                    svg.append("g")
                        .attr("transform", "translate("+margin+", "+margin+")")
                        .call(d3.axisLeft(y)
                        .tickValues([80,75,70,65,60,55,50])
                        .tickFormat(d3.format("~s")));
                    svg.append("g")
                        .attr("transform", "translate("+50+", "+(height+50)+")")
                        .call(d3.axisBottom(x)
                        .tickValues([1000, 2000, 5000, 10000, 20000, 50000, 100000])
                        .tickFormat(d3.format("$,")));

                    // Axis Labels
                    svg.append("text")
                        .attr("class", "x label")
                        .attr("text-anchor", "end")
                        .attr("x", width - 250)
                        .attr("y", height + 90)
                        .text("GDP per capita");
                    svg.append("text")
                        .attr("class", "y label")
                        .attr("text-anchor", "end")
                        .attr("x", -325)
                        .attr("y", 0)
                        .attr("dy", ".75em")
                        .attr("transform", "rotate(-90)")
                        .text("Life Expectancy (year)");

                    // Plot
                    svg
                        .append("g")
                            .attr("transform", "translate("+margin+", "+margin+")")
                        .selectAll("plots").data(data).enter()
                            .append("circle")
                            .style("opacity", 1)
                            .attr("cx", function(d) { return x(d.GDP); } )
                            .attr("cy", function(d) { return y(d.LifeExpectancy); } )
                            .attr("r", function(d) { return pop(d.Population); } )
                            .style("fill", function(d) { return color(d.Continent); } )
                            .style("stroke", "black")
                        .on("mouseover", function(d, i) {
                            tooltip
                                .style("opacity", 1)
                                .style("left",(d3.event.pageX + 90)+"px")
                                .style("top", (d3.event.pageY)+"px")
                                .html(d.Country 
                                + "<br>Life Expectancy: " + d3.format(",.1f")(d.LifeExpectancy)
                                + "<br>GDP: " + d3.format("$,.0f")(d.GDP) 
                                + "<br>Population: " + d3.format(",")(d.Population));
                        })
                        .on("mouseout", function() {
                            tooltip.style("opacity", 0);
                        });
                    
                    // Legend
                    // code source: https://d3-graph-gallery.com/graph/custom_legend.html
                    svg.append("g")
                        .selectAll("legendDots")
                    .data(continents)
                    .enter()
                    .append("rect")
                        .attr("x", 100)
                        .attr("y", function(d,i) { return 100 + i*25; })
                        .attr("width", 7)
                        .attr("height", 7)
                        .style("fill", function(d) { return color(d); });
                    
                    svg.append("g")
                        .selectAll("legendLabels")
                    .data(continents)
                    .enter()
                    .append("text")
                        .attr("x", 120)
                        .attr("y", function(d,i) { return 100 + i*25; })
                        .style("fill", "black")
                        .text(function(d) { return d; } )
                        .attr("text-anchor", "left")
                        .style("alignment-baseline", "middle") 
                    // Interactive legend
                    .on("click", function(d) {
                        if (d == currentFilter) {
                            svg.selectAll("circle")
                                .style("opacity", 1);
                            currentFilter = "none";
                        } else {
                            svg.selectAll("circle")
                                .style("opacity", 1);
                            svg.selectAll("circle")
                                .filter(function(l) { return l.Continent != d; })
                                .style("opacity", 0);
                            currentFilter = d;
                        }
                    });    

                    // Liniar trend
                    svg.append("line")
                            .style("opacity", 0)
                            .style("stroke", "red")
                            .style("stroke-width", 3)
                            .attr('x1', 50)
                            .attr('y1', 650)
                            .attr('x2', 650)
                            .attr('y2', 50)
                        .on("mouseover", function(d, i) {
                            tooltip
                                .style("opacity", 1)
                                .style("left",(d3.event.pageX + 90)+"px")
                                .style("top", (d3.event.pageY)+"px")
                                .html(d.Country 
                                + "<br>Life Expectancy: " + d3.format(",.1f")(d.LifeExpectancy)
                                + "<br>GDP: " + d3.format("$,.0f")(d.GDP) 
                                + "<br>Population: " + d3.format(",")(d.Population));
                        })
                        .on("mouseout", function() {
                            tooltip.style("opacity", 0);
                        });

                    // Checkbox
                    // source: https://d3-graph-gallery.com/graph/bubblemap_buttonControl.html
                    function update(){

                        // For each check box:
                        d3.selectAll(".checkbox").each(function(d){
                            cb = d3.select(this);
                            grp = cb.property("value");

                            // If the box is check, I show the group
                            if(cb.property("checked")){
                                svg.selectAll("line").transition().duration(1000).style("opacity", 1);

                            // Otherwise I hide it
                            }else{
                                svg.selectAll("line").transition().duration(1000).style("opacity", 0);
                            }
                        })
                    }

                    // When a button change, I run the update function
                    d3.selectAll(".checkbox").on("change",update);

                    // And I initialize it at the beginning
                    update();
                }
            </script>
        </body>
    </html>